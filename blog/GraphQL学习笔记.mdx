# ä»€ä¹ˆæ˜¯GraphQL
[GraphQL](https://graphql.org/),æ˜¯Facebookå¼€æºçš„ä¸€ç§apiæŸ¥è¯¢è¯­è¨€ï¼Œå¯¹æŸ¥è¯¢æ•°æ®æä¾›äº†ä¸€å¥—å®Œæ•´çš„æè¿°ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç²¾å‡†çš„è·å–éœ€è¦çš„æ•°æ®ï¼Œè€Œæ²¡æœ‰ä»»ä½•å†—ä½™

![graphql](./assets/typegraphql.jpg)

æœ€åŸºç¡€çš„æŸ¥è¯¢æ–¹å¼å¦‚ä¸Šå›¾ï¼Œå·¦è¾¹æ˜¯è¯·æ±‚ï¼Œå³è¾¹æ˜¯å“åº”ï¼Œæˆ‘å¸Œæœ›è·å–`todoList`è¿™ä¸ªé›†åˆï¼Œé›†åˆé‡Œçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åŒ…æ‹¬`_id,content,completed`å­—æ®µï¼ŒæœåŠ¡ç«¯è¿”å›çš„æ•°æ®å°±æ˜¯æˆ‘è¯·æ±‚éœ€è¦çš„æ•°æ®ï¼Œä¸ä¼šå¤šä¹Ÿä¸ä¼šå°‘

## GraphQLçš„åŸºç¡€æ¦‚å¿µâ€”â€”Query
``` graphql
    type todo {
        _id: ID!
        content: String!
        completed: Boolean!
    }
```
- `todo`è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªGraphQLçš„å¯¹è±¡
- `_id`ã€`content`å’Œ`completed`æ˜¯`todo`ä¸­çš„å­—æ®µï¼Œ`ID`ã€`String`ã€`Boolean`éƒ½æ˜¯graphqlå†…ç½®çš„ç±»å‹
- `String!`è¡¨ç¤ºè¿™ä¸ªå­—æ®µçš„å€¼ä¸º`String`ç±»å‹ä¸”ä¸å¯ä¸ºç©º

æ¥ç€åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢
``` graphql
    type Query {
        todoList: [todo]!
    }
```
- `Query`å’Œ`Mutetion`éƒ½æ˜¯GraphQLçš„å…³é”®å­—ï¼Œä¸€ä¸ªä»£è¡¨æŸ¥è¯¢ï¼Œä¸€ä¸ªä»£è¡¨å˜æ›´ï¼Œåœ¨è¿™é‡Œä½¿ç”¨äº†`Query`åˆ›å»ºäº†ä¸€ä¸ªæŸ¥è¯¢
- `[todo]!`è¡¨ç¤ºå­—æ®µ`todoList`çš„å€¼æ˜¯ä¸€ä¸ªä¸Šé¢å®šä¹‰çš„`todo`ç±»å‹çš„æ•°ç»„ï¼Œ`[todo]!`è¡¨ç¤ºè¿™ä¸ªå­—æ®µè¦ä¹ˆæ˜¯ç©ºæ•°ç»„`[]`ï¼Œè¦ä¹ˆæ˜¯å…ƒç´ ä¸º`todo`çš„æ•°ç»„`[todo,todo,...]`

## GraphQLä¸­çš„æ•°æ®ç±»å‹

- `Int`: æœ‰ç¬¦å·çš„32ä½æ•´æ•°
- `Float`: æœ‰ç¬¦å·çš„åŒç²¾åº¦æµ®ç‚¹å€¼
- `String`: UTFâ€8çš„å­—ç¬¦ä¸²
- `Boolean`: å¸ƒå°”
- `ID`: å”¯ä¸€çš„æ ‡è¯†ï¼Œåœ¨åºåˆ—åŒ–ä¸º`String`æ—¶è¡¨ç¤ºäººç±»ä¸å¯è¯»çš„

è¿˜å¯ä»¥[è‡ªå®šä¹‰ç±»å‹](https://www.apollographql.com/docs/apollo-server/features/scalars-enums#custom-scalars)


## æ­å»ºGraphQLæœåŠ¡å™¨
äº†è§£äº†æŸ¥è¯¢ï¼Œå°±æ¥åˆ›å»ºä¸€ä¸ªGraphQLçš„æœåŠ¡å™¨å§
æˆ‘ä½¿ç”¨çš„æ˜¯[Apollo GraphQL](https://www.apollographql.com/)ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å®Œæ•´çš„GraphQLçš„å®ç°ï¼ŒåŒ…æ‹¬äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯
nodeæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯[koa](https://koajs.com)
ç°åœ¨å°±å¼€å§‹å§

é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åå®‰è£…ä»¥ä¸‹ä¾èµ–
> `npm i -S apollo-server-koa graphql koa`

æ ¹ç›®å½•åˆ›å»º`app.js`æ–‡ä»¶
``` javascript
const Koa = require("koa");
const { ApolloServer } = require("apollo-server-koa");

const { gql } = require("apollo-server-koa");

// å®šä¹‰ä»æœåŠ¡å™¨è·å–æ•°æ®çš„graphqlæ–¹æ³•
const typeDefs = gql`
  type todo {
    _id: ID!
    content: String!
    completed: Boolean!
  }
  type Query {
    todoList: [todo]!
  }
`;

const server = new ApolloServer({
  // ä½¿ç”¨gqlæ ‡ç­¾å’Œå­—ç¬¦ä¸²å®šä¹‰çš„graphqlçš„DocumentNode
  typeDefs,
  // å¼€å¯mock
  mocks: true
});

const app = new Koa();

// applyMiddlewareå°†graphqlæœåŠ¡è¿æ¥åˆ°koaæ¡†æ¶
server.applyMiddleware({ app });

app.listen({ port: 4000 }, () =>
  console.log(`ğŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
);

```
æ¥ç€è¿è¡Œ`node app.js`ï¼Œåœ¨`http://localhost:4000/graphql`å°±èƒ½çœ‹è§`apollo server`æä¾›çš„`playground`äº†

**æŸ¥è¯¢**
``` graphql
{
  todoList{
    _id
    content
    completed
  }
}
```
åœ¨å·¦è¾¹è¾“å…¥ä¸Šæ–¹çš„æŸ¥è¯¢ï¼Œå³è¾¹å°±ä¼šå‡ºç°mockçš„æ•°æ®äº†

### æ·»åŠ resolvers
resolversæ˜¯ç”¨äºè§£ætypeDefsæŸ¥è¯¢çš„è§£æå™¨ï¼Œæ˜¯ä¸€ä¸ªé”®ä¸º`type`åï¼Œå€¼ä¸ºä¸€ä¸ªå‡½æ•°çš„æ˜ å°„
åœ¨`app.js`ä¸­æ·»åŠ `resolvers`
``` javascript
// ...
// åˆ›å»ºä¸€ä¸ªæ•°æ®
const data = [
  {
    _id: "5ca16ed7c39e5a03d8ad3547",
    content: "html5",
    completed: false
  },
  {
    _id: "5ca16ee0c39e5a03d8ad3548",
    content: "javascript",
    completed: false
  },
  {
    _id: "5ca16ee5c39e5a03d8ad3549",
    content: "css",
    completed: false
  }
];
// resolvers
// Queryå¯¹åº”æŸ¥è¯¢ï¼ŒtodoListæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›çš„æ˜¯æ•°æ®
// å¯ä»¥å†™å¼‚æ­¥å‡½æ•°ï¼Œç”¨äºçœŸå®çš„æ•°æ®åº“æŸ¥è¯¢
const resolvers = {
  Query: {
    todoList: () => data
  }
};
// æ·»åŠ resolversï¼Œå–æ¶ˆæ‰mocks
const server = new ApolloServer({
  typeDefs,
  resolvers,
});

const app = new Koa();
//...
```
å†æ¬¡æŸ¥è¯¢ï¼Œè¿”å›çš„ç»“æœå°±æ˜¯`data`çš„æ•°æ®äº†

## GraphQLçš„åŸºç¡€æ¦‚å¿µâ€”â€”Mutation
Mutationå¯ä»¥å¯¹åº”REST APIä¸­çš„CRUD,ä¸€ä¸ªç®€å•çš„`mutation`å¦‚ä¸‹
åœ¨`typeDefs`ä¸­å¢åŠ 
``` graphql
    type updateResponse {
        success: Boolean!
        todoList:[todo]!
    }
    type Mutation {
        addTodo(content: String): updateResponse!
    }
```
è¿™æ˜¯ä¸€ä¸ªMutationçš„æ“ä½œï¼Œå¢åŠ ä¸€ä¸ª`todo`é¡¹ï¼Œè¿”å›ä¸€ä¸ª`updateResponse`å¯¹è±¡
- `addTodo(content: String)`æ¥æ”¶ä¸€ä¸ªä¸º`String`ç±»å‹çš„å‚æ•°
- `updateResponse`å€¼åŒ…æ‹¬ä¸€ä¸ªé”®åä¸º`success`å€¼ä¸º`Boolean`å’Œä¸€ä¸ªé”®åä¸º`todoList`å€¼ä¸º`todo`çš„æ•°ç»„

### åœ¨playgroundä¸­æ‰§è¡Œ
**ä¿®æ”¹resolvers**
``` javascript
const resolvers = {
    Query: {
        todoList: () => data
    },
    Mutation: {
        addTodo: (_, { content }) => {
            console.log(content);
            data.push({
                _id:Math.random().toString(36).substring(3),
                content,
                completed:false
            });
            return { success: true, todoList:data };
        },
    }
};
```
å‡½æ•°ä¸­å…·ä½“çš„å‚æ•°å¯æŸ¥é˜…[Resolver type signature](https://www.apollographql.com/docs/apollo-server/essentials/data#type-signature)

**æ‰§è¡Œ**
``` graphql
mutation{
  addTodo(content:"css"){
    success
    todoList{
      _id
      content
      completed
    }
  }
}
```
`mutation`è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª`mutation`æ“ä½œï¼Œæ“ä½œåä¸º`addTodo`ï¼Œæ¥æ”¶ä¸€ä¸ªåä¸º`content`ç±»å‹ä¸º`String`çš„å‚æ•°ï¼Œè¿”å›çš„æ•°æ®æ˜¯`success`å’Œ`todoList`

åœ¨nodejsçš„æ§åˆ¶å°èƒ½çœ‹è§consoleå‡ºæ¥çš„å‚æ•°

## åœ¨å®¢æˆ·ç«¯ä¸­ä½¿ç”¨GraphQL

å®˜æ–¹æä¾›äº†åŒ…æ‹¬`react`ã€`react-native`ã€`vue`ã€`augular`ã€`native-ios`...ç­‰
[åœ¨creact-react-appä¸­ä½¿ç”¨](https://www.apollographql.com/docs/react/essentials/get-started)

è™½ç„¶å®˜æ–¹æä¾›äº†ç»„ä»¶æ¨¡å¼çš„`Query`å’Œ`Mutation`ç»„ä»¶ï¼Œä¸è¿‡æˆ‘åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œç”¨çš„è¿˜æ˜¯ç›´æ¥ä»¥JSå†™çš„æ–¹æ³•æ¨¡å¼,[Client apiå‚è€ƒ](https://www.apollographql.com/docs/react/api/apollo-client)

åœ¨`create-react-app`çš„é¡¹ç›®ä¸­å®‰è£…ä¾èµ–

`npm install apollo-boost react-apollo graphql --save`

åˆ›å»º`client.js`,å¹¶åœ¨`package.json`ä¸­å¢åŠ `proxy`
``` javascript
import ApolloClient from "apollo-boost";
const Client = new ApolloClient();
const getList = async () => {
    return await Client.query({
        query: gql`
            {
                todoList {
                    _id
                    content
                    completed
                }
            }
        `
    });
};
const add = async content => {
    return await Client.mutate({
		// å‚æ•°,contentå¯¹åº”çš„ä¸‹é¢çš„$content
        variables: { content },
        mutation: gql`
            mutation add($content: String!) {
                addTodo(content: $content) {
                    success
                    todoList{
                        _id
                        content
                        completed
                    }
                }
            }
        `
    })
};
export {getList,add};
```

## æä¾›IDEæ”¯æŒ
æˆ‘ä½¿ç”¨çš„æ˜¯webstormæ˜¯ä¸€æ¬¾é›†æˆåŠŸèƒ½éå¸¸å¼ºå¤§çš„IDEï¼Œåœ¨pluginsé‡Œæœç´¢å®‰è£…`JS GraphQL`

**å¯¼å‡º`schema.json`**
- `npm install -g apollo-codegen`
- å®¢æˆ·ç«¯æ ¹ç›®å½•æ‰§è¡Œ
`apollo-codegen introspect-schema http://localhost:4000/graphql --output graphql.schema.json`

webstromeå°±ä¼šæä¾›éå¸¸æ™ºèƒ½çš„graphqlä»£ç æ ¼å¼åŒ–å’Œè¡¥å…¨åŠŸèƒ½äº†

## Demo

å­¦ä¹ è¿‡ç¨‹ä¸­å†™äº†2ä¸ªdemo
[å®¢æˆ·ç«¯](https://github.com/zhangyu1818/todolist-graphql)
[æœåŠ¡ç«¯](https://github.com/zhangyu1818/koa-graphql-mongodb)

ä¸æ‡‚çš„åœ°æ–¹ä¾æ—§å¾ˆå¤šï¼Œæ–‡æ¡£æ˜¯è‹±æ–‡çš„åˆç‰¹åˆ«å¤æ‚ï¼Œè·¯æ¼«æ¼«å…¶ä¿®è¿œå…®~
ä¸çŸ¥ä½•ä»€ä¹ˆæ—¶å€™æ‰èƒ½æ­ä¸€ä¸ªåŸºäºgraphqlçš„åšå®¢å‘¢ï¼Œwordpressåˆæ…¢åˆé‡ï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯çœ‹ä¸æ‡‚â€¦â€¦
